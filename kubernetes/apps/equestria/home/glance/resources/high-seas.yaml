# yaml-language-server: $schema=https://raw.githubusercontent.com/not-first/glance-schema/master/schema.json#/properties/pages
- name: High Seas
  width: wide
  desktop-navigation-width: default
  head-widgets:
    - type: custom-api
      title: Prowlarr Indexers
      cache: 1m
      options:
        url: https://prowlarr.${ROOT_DOMAIN}
        base-url: https://prowlarr.${ROOT_DOMAIN}
        api-key: ${PROWLARR_APIKEY}
      template: |
        {{ $apiBaseUrl := .Options.StringOr "base-url" "" }}
        {{ $key := .Options.StringOr "api-key" "" }}
        {{ $url := .Options.StringOr "url" "" }}
        {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}

        {{ if or (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
          <div class="widget-error-header">
              <div class="color-negative size-h3">ERROR</div>
              <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
              </svg>
            </div>
            <p class="break-all">
              Some options are not set or malformed
                <table style="border-spacing: 1rem;">
                  <tr>
                    <td><strong>PROWLARR_URL & PROWLARR_API_URL</strong> <br/> should include http(s):// and port if needed</td>
                  </tr>
                  <tr>
                    <td><strong>PROWLARR_KEY</strong> <br/> must be set (Settings > General > Security)</td>
                  </tr>
                </table>
            </p>
        {{ else }}

          {{ $indexUrl := printf "%s/api/v1/indexer" $apiBaseUrl }}

          {{ $indexData := newRequest $indexUrl
            | withHeader "Accept" "application/json"
            | withHeader "X-Api-Key" $key
            | getResponse }}

          {{ if eq $indexData.Response.StatusCode 200 }}
            <style>
              .prowlarr-indexers .prowlarr-index-item
              {
                align-items: center;
              }
              .prowlarr-indexers .prowlarr-index-item > span{
                text-transform: capitalize;
                background: var(--color-background);
                padding: 0.2rem 0.75rem;
                border: 1px solid var(--color-widget-content-border);
                border-radius: var(--border-radius);
                font-size: var(--font-size-tiny);
              }
            </style>

            <ul class="prowlarr-indexers list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">

              {{ range $indexData.JSON.Array "" }}
                {{ $isEnabled := .String "enable" }}

                <li class="flex items-center gap-12 prowlarr-index-item">
                  <a href="{{ $url }}" target="_blank" class="size-title-dynamic color-highlight text-truncate block grow">{{ .String "name" }}</a>
                  <span>{{ .String "privacy" }}</span>
                  {{ if eq $isEnabled "true" }}
                    <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Enabled" aria-label="Enabled">
                      <div class="monitor-site-status-icon-compact" title="Enabled">
                        <svg fill="var(--color-positive)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                    </div>
                  {{ else }}
                    <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Disabled" aria-label="Disabled">
                      <div class="monitor-site-status-icon-compact" title="Disabled">
                        <svg fill="var(--color-negative)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                    </div>
                  {{ end }}

                </li>
              {{ end }}

            </ul>
          {{ else }}
            <p>Failed to fetch data (Status: {{ $indexData.Response.StatusCode }})</p>
          {{ end }}

        {{ end }}
    - type: custom-api
      title: SABnzbd
      cache: 1m
      url: ${SABNZBD_URL}/api?output=json&apikey=${SABNZBD_API_KEY}&mode=queue
      headers:
        Accept: application/json
      template: |
        <div class="p-2">
          <div class="flex justify-between mb-2">
            <div class="flex-1">
              <div class="size-h6">SPEED</div>
              <div class="color-highlight size-h3">{{ if eq (.JSON.String "queue.status") "Downloading" }}{{ .JSON.String "queue.speed" }}B/s{{ else }}Paused{{ end }}</div>
            </div>
            <div class="flex-1">
              <div class="size-h6">TIME LEFT</div>
              <div class="color-highlight size-h3">{{ if eq (.JSON.String "queue.status") "Downloading" }}{{ .JSON.String "queue.timeleft" }}{{ else }}--:--:--{{ end }}</div>
            </div>
          </div>
          <div class="flex justify-between mb-2">
            <div class="flex-1">
              <div class="size-h6">QUEUE</div>
              <div class="color-highlight size-h3">{{ .JSON.Int "queue.noofslots" }} items</div>
            </div>
            <div class="flex-1">
              <div class="size-h6">SIZE</div>
              <div class="color-highlight size-h3">{{ .JSON.Float "queue.mb" | printf "%.1f" }}MB</div>
            </div>
          </div>
        </div>
    - type: custom-api
      title: qBittorrent
      cache: 10s
      options:
        view: "detailed"   # "basic" or "detailed"
        mode: "default"    # "default" or "upload"
      subrequests:
        transfer:
          url: ${QBITTORRENT_URL}/api/v2/transfer/info
        seeding:
          url: ${QBITTORRENT_URL}/api/v2/torrents/info
          parameters:
            filter: seeding
        leeching:
          url: ${QBITTORRENT_URL}/api/v2/torrents/info
          parameters:
            filter: downloading
      template: |
        {{ $transfer := .Subrequest "transfer" }}
        {{ $seeding := .Subrequest "seeding" }}
        {{ $leeching := .Subrequest "leeching" }}

        {{ if and (eq $transfer.Response.StatusCode 200) (eq $seeding.Response.StatusCode 200) (eq $leeching.Response.StatusCode 200) }}

          {{ $isDetailed := eq (.Options.StringOr "view" "detailed") "detailed" }}
          {{ $mode := .Options.StringOr "mode" "default" }}

          {{ if $isDetailed }}
          <!-- Detailed View -->
          <div class="list" style="--list-gap: 15px;">
            <div class="flex justify-between text-center">
              <div>
                {{ $dlSpeed := $transfer.JSON.Float "dl_info_speed" }}
                {{ if eq $mode "upload" }}
                  <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}</div>
                {{ else }}
                  {{ if lt $dlSpeed 1048576.0 }}
                    <div class="color-highlight size-h3">{{ printf "%.0f KiB/s" (div $dlSpeed 1024.0) }}</div>
                  {{ else }}
                    <div class="color-highlight size-h3">{{ printf "%.1f MiB/s" (div $dlSpeed 1048576.0) }}</div>
                  {{ end }}
                {{ end }}
                <div class="size-h6">DOWNLOADING</div>
              </div>

              {{ if eq $mode "upload" }}
              <div>
                {{ $ulSpeed := $transfer.JSON.Float "up_info_speed" }}
                <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}</div>
                <div class="size-h6">UPLOADING</div>
              </div>
              {{ end }}

              <div>
                <div class="color-highlight size-h3">{{ len ($seeding.JSON.Array "") }}</div>
                <div class="size-h6">SEEDING</div>
              </div>

              {{ if eq $mode "default" }}
              <div>
                <div class="color-highlight size-h3">{{ len ($leeching.JSON.Array "") }}</div>
                <div class="size-h6">LEECHING</div>
              </div>
              {{ end }}
            </div>

            <!-- Downloading list -->
            {{ $downloadingTorrents := $leeching.JSON.Array "" }}
            {{ if gt (len $downloadingTorrents) 0 }}
              <div style="margin-top: 15px;">
                <ul class="list collapsible-container" data-collapse-after="0" style="--list-gap: 15px;">
                  {{ range $t := $downloadingTorrents }}
                    {{ $state := $t.String "state" }}
                    {{ $icon := "?" }}
                    {{ if ge ($t.Int "completed") ($t.Int "size") }}{{ $icon = "✔" }}
                    {{ else if eq $state "downloading" "forcedDL" }}{{ $icon = "↓" }}
                    {{ else if eq $state "pausedDL" "stoppedDL" "pausedUP" "stalledDL" "stalledUP" "queuedDL" "queuedUP" }}{{ $icon = "❚❚" }}
                    {{ else if eq $state "error" "missingFiles" }}{{ $icon = "!" }}
                    {{ else if eq $state "checkingDL" "checkingUP" "allocating" }}{{ $icon = "…" }}
                    {{ else if eq $state "checkingResumeData" }}{{ $icon = "⟳" }}
                    {{ end }}

                    <li class="flex items-center" style="gap: 10px;">
                      <div class="size-h4" style="flex-shrink: 0;">{{ $icon }}</div>
                      <div style="flex-grow: 1; min-width: 0;">
                        <div class="text-truncate color-highlight">{{ $t.String "name" }}</div>
                        <div title="{{ $t.Float "progress" | mul 100 | printf "%.1f" }}%" style="background: rgba(128, 128, 128, 0.2); border-radius: 5px; height: 6px; margin-top: 5px; overflow: hidden;">
                          <div style="width: {{ $t.Float "progress" | mul 100 }}%; background-color: var(--color-positive); height: 100%; border-radius: 5px;"></div>
                        </div>
                      </div>
                      <div style="flex-shrink: 0; text-align: right; width: 80px;">
                        {{ $dlSpeed := $t.Float "dlspeed" }}
                        <div class="size-sm color-paragraph">
                          {{ if eq $mode "upload" }}
                            {{ if lt $dlSpeed 1000.0 }}--{{ else }}{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}{{ end }}
                          {{ else }}
                            {{ if lt $dlSpeed 1024.0 }}--{{ else if lt $dlSpeed 1048576.0 }}{{ printf "%.0f KiB/s" (div $dlSpeed 1024.0) }}{{ else }}{{ printf "%.1f MiB/s" (div $dlSpeed 1048576.0) }}{{ end }}
                          {{ end }}
                        </div>
                        {{ $eta := $t.Int "eta" }}
                        <div class="size-sm color-paragraph">
                          {{ if eq $eta 8640000 }}∞
                          {{ else if gt $eta 3600 }}{{ printf "%dh %dm" (div $eta 3600) (mod (div $eta 60) 60) }}
                          {{ else if gt $eta 0 }}{{ printf "%dm" (div $eta 60) }}
                          {{ else }}--{{ end }}
                        </div>
                      </div>
                    </li>
                  {{ end }}
                </ul>
              </div>
            {{ end }}

            <!-- Seeding list -->
            {{ if eq $mode "upload" }}
              {{ $seedingTorrents := $seeding.JSON.Array "" }}
              {{ if gt (len $seedingTorrents) 0 }}
                <div style="margin-top: 20px;">
                  <ul class="list collapsible-container" data-collapse-after="0" style="--list-gap: 15px;">
                    {{ range $t := $seedingTorrents }}
                      {{ $state := $t.String "state" }}
                      {{ $icon := "↑" }}
                      {{ if eq $state "pausedUP" "stoppedUP" "stalledUP" "queuedUP" }}{{ $icon = "❚❚" }}
                      {{ else if eq $state "error" "missingFiles" }}{{ $icon = "!" }}
                      {{ else if eq $state "checkingUP" }}{{ $icon = "…" }}
                      {{ else if eq $state "checkingResumeData" }}{{ $icon = "⟳" }}
                      {{ end }}

                      <li class="flex items-center" style="gap: 10px;">
                        <div class="size-h4" style="flex-shrink: 0;">{{ $icon }}</div>
                        <div style="flex-grow: 1; min-width: 0;">
                          <div class="text-truncate color-highlight">{{ $t.String "name" }}</div>
                          <div class="size-sm color-paragraph">
                            Ratio: {{ printf "%.2f" ($t.Float "ratio") }} |
                            Size: {{ printf "%.1f GB" (div ($t.Float "size") 1073741824.0) }}
                          </div>
                        </div>
                        <div style="flex-shrink: 0; text-align: right; width: 80px;">
                          {{ $ulSpeed := $t.Float "upspeed" }}
                          <div class="size-sm color-paragraph">
                            {{ if lt $ulSpeed 1000.0 }}--{{ else }}{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}{{ end }}
                          </div>
                          <div class="size-sm color-paragraph">Upload</div>
                        </div>
                      </li>
                    {{ end }}
                  </ul>
                </div>
              {{ end }}
            {{ end }}

          </div>

          {{ else }}
          <!-- Basic View -->
          <div class="flex justify-between text-center">
            <div>
              {{ $dlSpeed := $transfer.JSON.Float "dl_info_speed" }}
              <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}</div>
              <div class="size-h6">DOWNLOADING</div>
            </div>
            {{ if eq $mode "upload" }}
            <div>
              {{ $ulSpeed := $transfer.JSON.Float "up_info_speed" }}
              <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}</div>
              <div class="size-h6">UPLOADING</div>
            </div>
            {{ end }}
            <div>
              <div class="color-highlight size-h3">{{ len ($seeding.JSON.Array "") }}</div>
              <div class="size-h6">SEEDING</div>
            </div>
            {{ if eq $mode "default" }}
            <div>
              <div class="color-highlight size-h3">{{ len ($leeching.JSON.Array "") }}</div>
              <div class="size-h6">LEECHING</div>
            </div>
            {{ end }}
          </div>
          {{ end }}

        {{ else }}
          <div class="color-negative text-center">
            <p>Error fetching qBittorrent data.</p>
            <p class="size-sm">Check URL and authentication bypass settings.</p>
          </div>
        {{ end }}

  columns:

    - size: small
      widgets:
        - $include: ./widgets/media-playing.yaml

    - size: full
      widgets:
      - type: custom-api
        title: Upcoming Movie
        title-url: https://radarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: radarr          # sonarr, radarr, or lidarr
          type: upcoming           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: false
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/radarrcover" # optional
          key: ${RADARR_API_KEY}
          api-base-url: https://radarr.${ROOT_DOMAIN}
          url: https://radarr.${ROOT_DOMAIN}
        template: &template |
          {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}
          {{ $showGrabbed := .Options.BoolOr "show-grabbed" false }}
          {{ $sortTime := .Options.StringOr "sort-time" "desc" }}
          {{ $coverProxy := .Options.StringOr "cover-proxy" "" }}
          {{ $size := .Options.StringOr "size" "medium" }}
          {{ $service := .Options.StringOr "service" "" }}
          {{ $type := .Options.StringOr "type" "" }}
          {{ $intervalH := .Options.IntOr "interval" 0 | mul 24 }}

          {{ $now := now | formatTime "2006-01-02T15:04:05" }}
          {{ $posInterval := (offsetNow (printf "+%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}
          {{ $negInterval := (offsetNow (printf "-%dh" $intervalH)) | formatTime "2006-01-02T15:04:05" }}

          {{ $apiBaseUrl := .Options.StringOr "api-base-url" "" }}
          {{ $key := .Options.StringOr "key" "" }}
          {{ $url := .Options.StringOr "url" $apiBaseUrl }}

          {{ if or (and (ne $service "sonarr") (ne $service "radarr") (ne $service "lidarr"))
                  (and (ne $type "upcoming") (ne $type "recent") (ne $type "missing"))
                  (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
            <div class="widget-error-header">
                <div class="color-negative size-h3">ERROR</div>
                <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                </svg>
              </div>
              <p class="break-all">
                Some options are not set or malformed
                  <table style="border-spacing: 1rem;">
                    <tr><td>service</td><td>{{ $service }}</td><td>must be sonarr, radarr, or lidarr</td></tr>
                    <tr><td>type</td><td>{{ $type }}</td><td>must be upcoming, recent, or missing</td></tr>
                    <tr><td>api-base-url</td><td>{{ $apiBaseUrl }}</td><td>should include http(s):// and port if needed</td></tr>
                    <tr><td>key</td><td>{{ $key }}</td><td></td></tr>
                  </table>
              </p>
          {{ else }}
            {{ $requestUrl := "" }}

            {{ if eq $service "sonarr" }}
              {{ if eq $type "recent" }}
                {{ $requestUrl = printf "%s/api/v3/history/since?includeSeries=true&includeEpisode=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
              {{ else if eq $type "missing" }}
                {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50&includeSeries=true" $apiBaseUrl }}
              {{ else if eq $type "upcoming" }}
                {{ $requestUrl = printf "%s/api/v3/calendar?includeSeries=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
              {{ end }}

            {{ else if eq $service "radarr" }}
              {{ if eq $type "recent" }}
                {{ $requestUrl = printf "%s/api/v3/history/since?includeMovie=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
              {{ else if eq $type "missing" }}
                {{ $requestUrl = printf "%s/api/v3/wanted/missing?page=1&pageSize=50" $apiBaseUrl }}
              {{ else if eq $type "upcoming" }}
                {{ $requestUrl = printf "%s/api/v3/calendar?start=%s&end=%s" $apiBaseUrl $now $posInterval }}
              {{ end }}

            {{ else if eq $service "lidarr" }}
              {{ if eq $type "recent" }}
                {{ $requestUrl = printf "%s/api/v1/history/since?includeArtist=true&includeAlbum=true&eventType=grabbed&date=%s" $apiBaseUrl $negInterval }}
              {{ else if eq $type "missing" }}
                {{ $requestUrl = printf "%s/api/v1/wanted/missing?page=1&pageSize=50&includeArtist=true" $apiBaseUrl }}
              {{ else if eq $type "upcoming" }}
                {{ $requestUrl = printf "%s/api/v1/calendar?includeArtist=true&start=%s&end=%s" $apiBaseUrl $now $posInterval }}
              {{ end }}
            {{ end }}

            {{ $data := newRequest $requestUrl
              | withHeader "Accept" "application/json"
              | withHeader "X-Api-Key" $key
              | getResponse }}

            <ul class="list list-gap-14 collapsible-container single-line-titles" data-collapse-after="{{ $collapseAfter }}">
              {{ $array := "" }}
              {{ $sortByField := "" }}
              {{ $itemDisplayed := false }}
              {{ $itemDate := "" }}
              {{ $isAvailable := false }}

              {{ if eq $type "missing" }}
                {{ $array = "records" }}
                {{ if eq $service "sonarr" }}
                  {{ $sortByField = "airDateUtc" }}
                {{ else }}
                  {{ $sortByField = "releaseDate" }}
                {{ end }}
              {{ else if eq $type "recent" }}
                {{ $sortByField = "date" }}
              {{ else }}
                {{ if eq $service "sonarr" }}
                  {{ $sortByField = "airDateUtc" }}
                {{ else }}
                  {{ $sortByField = "releaseDate" }}
                {{ end }}
              {{ end }}

              {{ range $data.JSON.Array $array | sortByTime $sortByField "rfc3339" $sortTime }}

                {{ if eq $service "sonarr" }}
                  {{ $itemDate = .String "airDateUtc" | parseTime "RFC3339" }}
                  {{ $itemDate = $itemDate.In now.Location | formatTime "2006-01-02T15:04:05" }}
                  {{ $isAvailable = true }}
                {{ else if eq $service "radarr"}}
                  {{ $isAvailable = .Bool "isAvailable" }}
                  {{ $itemDate = .String "releaseDate" }}
                {{ else if eq $service "lidarr"}}
                  {{ $itemDate = .String "releaseDate" }}
                  {{ $isAvailable = true }}
                {{ end }}

                {{ if or (eq $type "upcoming") (eq $type "recent") (and (or (and (gt $itemDate $negInterval) ((lt $itemDate $now ))) (eq $intervalH 0))  $isAvailable) }}
                  {{ $itemDisplayed = true }}
                  {{ $title := "" }}
                  {{ $subtitle := "" }}
                  {{ $coverUrl := "" }}
                  {{ $status := "" }}
                  {{ $coverBase := "" }}
                  {{ $height := "" }}
                  {{ $width := "" }}
                  {{ $popoverTitle := "" }}
                  {{ $popoverSubtitle := "" }}
                  {{ $popoverSummary := "" }}
                  {{ $summary := "" }}
                  {{ $link := "" }}
                  {{ $grabbed := false }}
                  {{ $date := now }}
                  {{ $datetype := "" }}
                  {{ $seString := "" }}
                  {{ $genres := "" }}
                  {{ $buttonJustify := "left" }}


                  {{ if eq $service "sonarr" }}
                    {{ $series := "" }}
                    {{ if eq $coverProxy "" }}
                      {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                      {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "seriesId") $key }}
                    {{ else }}
                      {{ $coverBase = $coverProxy }}
                      {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "seriesId") }}
                    {{ end }}
                    {{ $title = .String "series.title" }}
                    {{ $link = printf "%s/series/%s#" $url (.String "series.titleSlug") }}
                    {{ $series = .Get "series" }}
                    {{ $genres = $series.Get "genres" }}

                    {{ if eq $type "recent" }}
                      {{ $date = .String "date" | parseLocalTime "RFC3339" }}
                      {{ $date = $date.In now.Location }}
                      {{ $subtitle = .String "episode.title" }}
                      {{ $summary = .String "episode.overview" }}
                      {{ $seString = printf "S%02dE%02d" (.Int "episode.seasonNumber") (.Int "episode.episodeNumber") }}
                      {{ $datetype = "Downloaded" }}

                      {{ if $showGrabbed }}
                        {{ $popoverTitle = .String "episode.title" }}
                        {{ $popoverSubtitle = $seString }}
                        {{ $popoverSummary = .String "episode.overview" }}
                        {{ if .Bool "episode.hasFile" }}
                          {{ $grabbed = true }}
                        {{ end }}
                      {{ else }}
                        {{ $popoverTitle = .String "series.title" }}
                        {{ $popoverSummary = .String "series.overview" }}
                      {{ end }}

                    {{ else if eq $type "missing" }}
                      {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                      {{ $date = $date.In now.Location }}
                      {{ $subtitle = .String "title" }}
                      {{ $summary = .String "overview" }}
                      {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                      {{ $datetype = "Aired" }}
                      {{ if $showGrabbed }}
                        {{ $popoverTitle = .String "title" }}
                        {{ $popoverSubtitle = $seString }}
                        {{ $popoverSummary = .String "overview" }}
                        {{ if .Bool "episode.hasFile" }}
                          {{ $grabbed = true }}
                        {{ end }}
                      {{ else }}
                        {{ $popoverTitle = .String "series.title" }}
                        {{ $popoverSummary = .String "series.overview" }}
                      {{ end }}
                    {{ else if eq $type "upcoming" }}
                      {{ $date = .String "airDateUtc" | parseLocalTime "RFC3339" }}
                      {{ $date = $date.In now.Location }}
                      {{ $subtitle = .String "title" }}
                      {{ $summary = .String "overview" }}
                      {{ $seString = printf "S%02dE%02d" (.Int "seasonNumber") (.Int "episodeNumber") }}
                      {{ $datetype = "Airs" }}
                      {{ if $showGrabbed }}
                        {{ $popoverTitle = .String "title" }}
                        {{ $popoverSubtitle = $seString }}
                        {{ $popoverSummary = .String "overview" }}
                        {{ if .Bool "hasFile" }}
                          {{ $grabbed = true }}
                        {{ end }}
                      {{ else }}
                        {{ $popoverTitle = .String "series.title" }}
                        {{ $popoverSummary = .String "series.overview" }}
                      {{ end }}
                    {{ end }}


                  {{ else if eq $service "radarr" }}
                    {{ $movie := "" }}
                    {{ $status = .String "status" }}
                    {{ if eq $coverProxy "" }}
                      {{ $coverBase = printf "%s/api/v3/mediacover" $apiBaseUrl }}
                    {{ else }}
                      {{ $coverBase = $coverProxy }}
                    {{ end }}
                    {{ if eq $status "announced"}}
                      {{ if ne (.String "inCinemas") "" }}
                        {{ $date = (.String "inCinemas" | parseTime "RFC3339") }}
                        {{ $datetype = "In Cinemas" }}
                      {{ else }}
                        {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                        {{ $datetype = "Releases" }}
                      {{ end }}
                    {{ else if eq $status "inCinemas"}}
                      {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                      {{ $datetype = "Releases" }}
                    {{ else if eq $status "released"}}
                      {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                      {{ $datetype = "Released" }}
                    {{ end }}

                    {{ if eq $type "recent" }}
                      {{ if eq $coverProxy "" }}
                        {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "movie.id") $key }}
                      {{ else }}
                        {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "movie.id") }}
                      {{ end }}
                      {{ $datetype = "Downloaded" }}
                      {{ $date = (.String "date" | parseTime "RFC3339") }}
                      {{ $title = .String "movie.title" }}
                      {{ $subtitle = "" }}
                      {{ $summary = .String "movie.overview" }}
                      {{ $popoverTitle = .String "movie.title" }}
                      {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                      {{ $popoverSummary = .String "movie.overview" }}
                      {{ $link = printf "%s/movie/%s#" $url (.String "movie.titleSlug") }}
                      {{ $movie = .Get "movie" }}
                      {{ $genres = $movie.Get "genres" }}
                      {{ if and $showGrabbed (gt (.Int "movie.movieFileId") 0) }}
                        {{ $grabbed = true }}
                      {{ end }}
                    {{ else }}
                      {{ if eq $coverProxy "" }}
                        {{ $coverUrl = printf "%s/%s/poster-500.jpg?apikey=%s" $coverBase (.String "id") $key }}
                      {{ else }}
                        {{ $coverUrl = printf "%s/%s/poster-500.jpg" $coverBase (.String "id") }}
                      {{ end }}
                      {{ $title = .String "title" }}
                      {{ $subtitle = "" }}
                      {{ $summary = .String "overview" }}
                      {{ $link = printf "%s/movie/%s#" $url (.String "titleSlug") }}
                      {{ $popoverTitle = .String "title" }}
                      {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                      {{ $popoverSummary = .String "overview" }}
                      {{ $genres = .Get "genres" }}
                      {{ if eq $type "missing" }}
                        {{ if and $showGrabbed (.Bool "movie.hasFile") }}
                          {{ $grabbed = true }}
                        {{ end }}
                      {{ else }}
                        {{ if and $showGrabbed (.Bool "hasFile") }}
                          {{ $grabbed = true }}
                        {{ end }}
                      {{ end }}
                    {{ end }}


                  {{ else if eq $service "lidarr" }}
                    {{ $artist := "" }}
                    {{ $album := "" }}
                    {{ $albumId := "" }}
                    {{ if eq $coverProxy "" }}
                      {{ $coverBase = printf "%s/api/v1/mediacover" $apiBaseUrl }}
                    {{ else }}
                      {{ $coverBase = $coverProxy }}
                    {{ end }}

                    {{ if eq $type "recent" }}
                      {{ $album = .Get "album" }}
                      {{ $artist = $album.Get "artist" }}
                      {{ if eq $coverProxy "" }}
                        {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase (.String "albumId") $key }}
                      {{ else }}
                        {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase (.String "albumId") }}
                      {{ end }}
                      {{ $grabbed = true }}
                      {{ $title = $album.String "title" }}
                      {{ $date = (.String "date" | parseTime "RFC3339") }}
                      {{ $datetype = "Downloaded" }}
                      {{ $subtitle = $artist.String "artistName" }}
                      {{ $genres = $artist.Get "genres" }}
                      {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                      {{ $summary = $album.String "overview" }}
                      {{ $popoverTitle = $album.String "title" }}
                      {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                      {{ $popoverSummary = $artist.String "overview" }}

                    {{ else }}
                      {{ $artist = .Get "artist" }}
                      {{ $album = .Get "album" }}
                      {{ if eq $type "missing" }}
                        {{ $datetype = "Released" }}
                      {{ else }}
                        {{ $datetype = "Releases" }}
                      {{ end }}
                      {{ range .Array "releases" }}
                        {{ $albumId = .String "albumId" }}
                        {{ break }}
                      {{ end }}
                      {{ if eq $coverProxy "" }}
                        {{ $coverUrl = printf "%s/album/%s/cover-500.jpg?apikey=%s" $coverBase $albumId $key }}
                      {{ else }}
                        {{ $coverUrl = printf "%s/album/%s/cover-500.jpg" $coverBase $albumId }}
                      {{ end }}
                      {{ $date = (.String "releaseDate" | parseTime "RFC3339") }}
                      {{ $title = .String "title" }}
                      {{ $subtitle = $artist.String "artistName" }}
                      {{ $summary = $album.String "overview" }}
                      {{ $genres = $artist.Get "genres" }}
                      {{ $link = printf "%s/artist/%s#" $url ($artist.String "foreignArtistId") }}
                      {{ $popoverTitle = .String "title" }}
                      {{ $popoverSubtitle = printf "%s %s" $datetype ($date | formatTime "1/2/2006") }}
                      {{ $popoverSummary = .String "artist.overview" }}
                    {{ end }}
                  {{ end }}

                  {{ if eq $size "small" }}
                    {{ $buttonJustify = "right" }}
                    {{ $height = "9rem" }}
                    {{ if eq $service "lidarr" }}
                      {{ $width = "9rem" }}
                    {{ else }}
                      {{ $width = "6rem" }}
                    {{ end }}
                  {{ else if eq $size "medium" }}
                    {{ $height = "12rem" }}
                    {{ if eq $service "lidarr" }}
                      {{ $width = "12rem" }}
                    {{ else }}
                      {{ $width = "8rem" }}
                    {{ end }}
                  {{ else if eq $size "large" }}
                    {{ $height = "15rem" }}
                    {{ if eq $service "lidarr" }}
                      {{ $width = "15rem" }}
                    {{ else }}
                      {{ $width = "10rem" }}
                    {{ end }}
                  {{ else if eq $size "huge" }}
                    {{ $height = "18rem" }}
                    {{ if eq $service "lidarr" }}
                      {{ $width = "18rem" }}
                    {{ else }}
                      {{ $width = "12rem" }}
                    {{ end }}
                  {{ end }}

                  <li style="position: relative;">
                    <div class="flex gap-10 items-start thumbnail-container thumbnail-parent">
                      <div>
                        <div data-popover-type="html" data-popover-position="above" data-popover-show-delay="500" style="width: {{ $width  }}; height: {{ $height }}; align-content: center;">
                          <div data-popover-html>
                            <div style="margin: 5px;">
                              <strong class="size-h4 color-primary" title="{{ $popoverTitle }}">{{ $popoverTitle }}</strong>
                              <div class="size-h4 text-truncate text-very-compact color-subdue" title="{{ $popoverSubtitle }}">{{ $popoverSubtitle }}</div>
                              <p class="margin-top-20" style="overflow-y: auto; text-align: justify; max-height: 20rem;">
                                {{ if ne $popoverSummary "" }}
                                  {{ $popoverSummary }}
                                {{ else }}
                                  TBA
                                {{ end }}
                              </p>
                            {{ if gt (len ($genres.Array "")) 0 }}
                              <ul class="attachments margin-top-20">
                                {{ range $genres.Array "" }}
                                  <li>{{ .String "" }}</li>
                                {{ end }}
                              </ul>
                              {{ end }}
                            </div>
                          </div>
                          <img class="thumbnail" src="{{ $coverUrl }}" alt="Cover for {{ .String "title" }}" loading="lazy" style="width: 100%; height: 100%; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); object-fit: cover; border-radius: 0.5rem;">
                        </div>
                    </div>
                      <div class="shrink min-width-0" style="height: 9rem; position: relative; padding-top: 5px; padding-right: 5px;">
                        <strong class="size-h4 block text-truncate color-primary" title="{{ $title }}">{{ $title }}</strong>
                        <div class="text-truncate text-very-compact" title="{{ $subtitle }}">{{ $subtitle }}</div>
                        <div class="text-very-compact text-truncate">
                          {{ if eq $service "sonarr" }}
                            <div>{{ $seString }} - {{ $datetype }} {{ $date.Format "1/2 03:04PM" }}</div>
                          {{ else }}
                            <span>{{ $datetype }} {{ $date.Format "1/2" }}</span>
                          {{ end }}
                        </div>

                        {{ if $showGrabbed }}
                          {{ if eq $buttonJustify "right" }}
                            </div>
                            <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                              style="position: absolute; bottom: 1rem; right: 1rem;
                                {{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                            {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                            </a>
                          {{ else }}
                            <a href="{{ $link }}" class="bookmarks-link size-h4 color-primary" target="_blank" rel="noreferrer"
                              style="{{ if $grabbed }} color: var(--color-positive); border: 1px solid var(--color-positive); {{ else }} color: var(--color-negative); border: 1px solid var(--color-negative); {{ end }}
                                font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 5px; text-decoration: none;">
                            {{ if $grabbed }}Grabbed{{ else }}Missing{{ end }}
                            </a>
                            </div>
                          {{ end }}
                        {{ else }}
                          <div class="{{ if eq $size "small" }}text-truncate{{ if eq $service "radarr" }} margin-top-5{{ end }}{{ else }}text-truncate-2-lines margin-top-5{{ end }}">
                            {{ $summary }}
                          </div>
                        {{ end }}
                    </div>
                  </li>
                {{ end }}
              {{ end }}
              {{ if not $itemDisplayed }}
                <li>No items found.</li>
              {{ end }}
            </ul>
          {{ end }}
      - type: custom-api
        title: Upcoming TV
        title-url: https://sonarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: sonarr          # sonarr, radarr, or lidarr
          type: upcoming           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: false
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/sonarrcover" # optional
          key: ${SONARR_API_KEY}
          api-base-url: https://sonarr.${ROOT_DOMAIN}
          url: https://sonarr.${ROOT_DOMAIN}
        template: *template
      - type: custom-api
        title: Upcoming Music
        title-url: https://lidarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: lidarr          # sonarr, radarr, or lidarr
          type: upcoming           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: false
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/lidarrcover" # optional
          key: ${LIDARR_API_KEY}
          api-base-url: https://lidarr.${ROOT_DOMAIN}
          url: https://lidarr.${ROOT_DOMAIN}
        template: *template
      

    - size: full
      widgets:
      - type: custom-api
        title: Movie Releases
        title-url: https://radarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: radarr          # sonarr, radarr, or lidarr
          type: recent           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: true
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/radarrcover" # optional
          key: ${RADARR_API_KEY}
          api-base-url: https://radarr.${ROOT_DOMAIN}
          url: https://radarr.${ROOT_DOMAIN}
        template: *template
      - type: custom-api
        title: TV Releases
        title-url: https://sonarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: sonarr          # sonarr, radarr, or lidarr
          type: recent           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: true
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/sonarrcover" # optional
          key: ${SONARR_API_KEY}
          api-base-url: https://sonarr.${ROOT_DOMAIN}
          url: https://sonarr.${ROOT_DOMAIN}
        template: *template
      - type: custom-api
        title: Music Releases
        title-url: https://lidarr.${ROOT_DOMAIN}
        cache: 5m
        options:
          service: lidarr          # sonarr, radarr, or lidarr
          type: recent           # upcoming, recent, or missing
          size: small             # small, medium, large, or huge
          collapse-after: 4
          show-grabbed: true
          interval: 20             # optional, days
          sort-time: asc          # optional, asc or desc (default)
          #cover-proxy: "https://proxy.example.com/lidarrcover" # optional
          key: ${LIDARR_API_KEY}
          api-base-url: https://lidarr.${ROOT_DOMAIN}
          url: https://lidarr.${ROOT_DOMAIN}
        template: *template

# https://github.com/glanceapp/community-widgets/blob/main/widgets/prowlarr-indexers/README.md
# https://github.com/glanceapp/community-widgets/tree/main/widgets/sabnzbd-stats
# https://github.com/glanceapp/community-widgets/tree/main/widgets/romm-stats
