# yaml-language-server: $schema=https://raw.githubusercontent.com/not-first/glance-schema/master/schema.json#/properties/pages
- name: Staging Media
  columns:

    # - size: small
    #   widgets:
    #     # Proxmox Backup Server Stats
    #     - type: custom-api
    #       title: PBS Stats
    #       cache: 5m
    #       allow-insecure: true
    #       url: https://${pbs_host}/api2/json/nodes/localhost/status
    #       headers:
    #         Authorization: ${pbs_token}
    #       template: |
    #         <style>
    #           .pbs-stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-separator); }
    #           .pbs-stat-label { font-weight: 500; }
    #           .pbs-stat-value { color: var(--color-highlight); }
    #         </style>
    #         {{ if eq .Response.StatusCode 200 }}
    #           {{ $data := .JSON.Get "data" }}
    #           {{ $cpuUsage := mul ($data.Float "cpu") 100.0 }}
    #           {{ $memPercent := mul (div ($data.Float "memory.used") ($data.Float "memory.total")) 100.0 }}
    #           {{ $diskPercent := mul (div ($data.Float "root.used") ($data.Float "root.total")) 100.0 }}
    #           <div class="pbs-stat">
    #             <span class="pbs-stat-label">CPU</span>
    #             <span class="pbs-stat-value">{{ printf "%.0f" $cpuUsage }}%</span>
    #           </div>
    #           <div class="pbs-stat">
    #             <span class="pbs-stat-label">RAM</span>
    #             <span class="pbs-stat-value">{{ printf "%.0f" $memPercent }}%</span>
    #           </div>
    #           <div class="pbs-stat">
    #             <span class="pbs-stat-label">Disk</span>
    #             <span class="pbs-stat-value">{{ printf "%.0f" $diskPercent }}%</span>
    #           </div>
    #         {{ else }}
    #           <p class="color-negative">Failed to connect to PBS</p>
    #         {{ end }}

    #     # Cloudflare Tunnels
    #     - type: custom-api
    #       title: Cloudflare Tunnels
    #       cache: 4h
    #       url: https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNTID}/cfd_tunnel/${CF_USERNAME}/configurations
    #       headers:
    #         Authorization: Bearer ${CF_CREDENTIAL}
    #       template: |
    #         {{ if eq .Response.StatusCode 200 }}
    #           <ul class="list list-gap-10">
    #           {{ range .JSON.Array "result.config.ingress" }}
    #             {{ if (.String "hostname") }}
    #               <li style="padding: 6px 0;">
    #                 <a href="https://{{ .String "hostname" }}" class="color-highlight" target="_blank" style="text-decoration: none;">
    #                   {{ .String "hostname" | trimSuffix ".${ROOT_DOMAIN}" }}
    #                 </a>
    #                 {{ if (.String "service") }}
    #                   <div style="font-size: 0.85rem; color: var(--color-subdue); margin-top: 2px;">
    #                     → {{ .String "service" }}
    #                   </div>
    #                 {{ end }}
    #               </li>
    #             {{ end }}
    #           {{ end }}
    #           </ul>
    #         {{ else }}
    #           <p class="color-negative">Failed to load tunnels (Status: {{ .Response.StatusCode }})</p>
    #         {{ end }}

    #     # Prowlarr Indexers
    #     - type: custom-api
    #       title: Prowlarr Indexers
    #       cache: 1m
    #       url: http://prowlarr.equestria.svc.cluster.local:9696/api/v1/indexer
    #       headers:
    #         Accept: application/json
    #         X-Api-Key: ${PROWLARR_APIKEY}
    #       template: |
    #         {{ if eq .Response.StatusCode 200 }}
    #           <ul class="list list-gap-8">
    #           {{ range .JSON.Array "" }}
    #             <li style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
    #               <a href="http://prowlarr.equestria.svc.cluster.local:9696" target="_blank" class="color-highlight" style="text-decoration: none; flex: 1;">{{ .String "name" }}</a>
    #               {{ if eq (.String "enable") "true" }}
    #                 <span style="color: var(--color-positive); font-weight: bold;">✓</span>
    #               {{ else }}
    #                 <span style="color: var(--color-negative); font-weight: bold;">✗</span>
    #               {{ end }}
    #             </li>
    #           {{ end }}
    #           </ul>
    #         {{ else }}
    #           <p class="color-negative">Failed to load indexers</p>
    #         {{ end }}

    # Media Servers
    - size: small
      widgets:
        # Tautulli Stats
        - type: custom-api
          title: Tautulli Stats
          url: ${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_activity
          cache: 5m
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "response.data.sessions" }}
                <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <strong>{{ .String "full_title" }}</strong><br>
                  <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "user" }} • {{ .String "quality_profile" }}</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load Tautulli data</p>
            {{ end }}

        # Media Server History (Plex)
        - type: custom-api
          title: Recently Played
          url: ${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_history&length=10
          cache: 5m
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "response.data.data" }}
                <li style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <span>{{ .String "full_title" }}</span>
                  <span style="color: var(--color-subdue); font-size: 0.85rem;">{{ .String "user" }}</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load history</p>
            {{ end }}

        # Media Server Playing (Active Sessions)
        - type: custom-api
          title: Now Playing
          url: ${TAUTULLI_URL}/api/v2?apikey=${TAUTULLI_API_KEY}&cmd=get_activity
          cache: 30s
          template: |
            {{ if eq .Response.StatusCode 200 }}
              {{ if eq (len (.JSON.Array "response.data.sessions")) 0 }}
                <p class="color-subdue">No active sessions</p>
              {{ else }}
                <ul class="list list-gap-8">
                {{ range .JSON.Array "response.data.sessions" }}
                  <li style="padding: 8px 0; border-bottom: 1px solid var(--color-separator);">
                    <strong>{{ .String "full_title" }}</strong><br>
                    <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "user" }} • {{ .String "state" }}</span>
                  </li>
                {{ end }}
                </ul>
              {{ end }}
            {{ else }}
              <p class="color-negative">Failed to load playback data</p>
            {{ end }}

        # Jellyfin Latest
        - type: custom-api
          title: Jellyfin Latest
          url: ${JELLYFIN_URL}/api/Users/${JELLYFIN_USER_ID}/Items/Latest?api_key=${JELLYFIN_API_KEY}&limit=10
          cache: 1h
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "" }}
                <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <span>{{ .String "Name" }}</span><br>
                  <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "Type" }}</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load Jellyfin content</p>
            {{ end }}

    # Infrastructure & Detailed Resources
    - size: full
      widgets:
        # # Proxmox Detailed Resources
        # - type: custom-api
        #   title: Proxmox Resources
        #   url: https://${proxmox_endpoint}/api2/json/nodes
        #   cache: 2m
        #   allow-insecure: true
        #   headers:
        #     Authorization: PVEAPIToken=${proxmox_credential}
        #   template: |
        #     {{ if eq .Response.StatusCode 200 }}
        #       <ul class="list list-gap-8">
        #       {{ range .JSON.Array "data" }}
        #         {{ if eq (.String "type") "qemu" }}
        #           <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
        #             <strong>{{ .String "name" }}</strong><br>
        #             <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "status" }} • CPU: {{ .String "cpu" }}% • RAM: {{ .String "memory" }}%</span>
        #           </li>
        #         {{ end }}
        #       {{ end }}
        #       </ul>
        #     {{ else }}
        #       <p class="color-negative">Failed to load Proxmox resources</p>
        #     {{ end }}

        # Grafana Metrics
        - type: custom-api
          title: Grafana
          url: ${GRAFANA_URL}/api/health
          cache: 5m
          headers:
            Authorization: Bearer ${GRAFANA_TOKEN}
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <div style="padding: 10px; background: rgba(0,0,0,0.05); border-radius: 6px;">
                <p style="margin: 0; color: var(--color-highlight);">Grafana Connected</p>
                <a href="${GRAFANA_URL}/d/" target="_blank" class="color-primary" style="text-decoration: none; font-size: 0.85rem;">→ View Dashboards</a>
              </div>
            {{ else }}
              <p class="color-negative">Failed to connect to Grafana</p>
            {{ end }}

- name: Staging Infra
  columns:
    # Media & Arr Stack
    - size: full
      widgets:
        # Arr Releases (Sonarr)
        - type: custom-api
          title: Sonarr Upcoming
          url: ${SONARR_URL}/api/v3/calendar?includeUnmonitored=false
          cache: 30m
          headers:
            X-Api-Key: ${SONARR_API_KEY}
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "" }}
                <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <strong>{{ .String "series.title" }}</strong><br>
                  <span style="font-size: 0.85rem; color: var(--color-subdue);">S{{ printf "%02d" (.Int "seasonNumber") }}E{{ printf "%02d" (.Int "episodeNumber") }} • {{ .String "airDateUtc" | slice 0 10 }}</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load Sonarr data</p>
            {{ end }}

        # Unifi Network Widget
        - type: custom-api
          title: UniFi Network
          url: ${DISCORD_URL}/api/s/default/stat/uptime
          cache: 1m
          allow-insecure: true
          headers:
            Authorization: Bearer ${UNIFI_API_KEY}
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <style>
                .unifi-stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--color-separator); }
                .unifi-label { font-weight: 500; }
                .unifi-value { color: var(--color-highlight); }
              </style>
              {{ $d := index (.JSON.Array "data") 0 }}
              {{ if $d }}
              {{ with $d }}
                <div class="unifi-stat">
                  <span class="unifi-label">Gateway</span>
                  <span class="unifi-value">{{ .String "status" }}</span>
                </div>
                <div class="unifi-stat">
                  <span class="unifi-label">Uptime</span>
                  <span class="unifi-value">{{ div (.Int "uptime") 86400 }}d</span>
                </div>
              {{ end }}
              {{ end }}
            {{ else }}
              <p class="color-negative">Failed to connect to UniFi</p>
            {{ end }}

    # Backup & Media Libraries
    - size: small
      widgets:
        # Backrest Backup Status
        - type: custom-api
          title: Backrest Backups
          method: POST
          url: ${BACKREST_LUNA_URL}/api/stats
          cache: 5m
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "snapshots" }}
                <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <strong>{{ .String "id" | slice 0 8 }}</strong><br>
                  <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "time" | slice 0 10 }} • {{ .String "size.GB" }}GB</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load backups</p>
            {{ end }}

        # Backrest Backup Status (Celestia)
        - type: custom-api
          title: Backrest Backups (Celestia)
          method: POST
          url: ${BACKREST_CELESTIA_URL}/api/stats
          cache: 5m
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "snapshots" }}
                <li style="padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <strong>{{ .String "id" | slice 0 8 }}</strong><br>
                  <span style="font-size: 0.85rem; color: var(--color-subdue);">{{ .String "time" | slice 0 10 }} • {{ .String "size.GB" }}GB</span>
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load backups</p>
            {{ end }}

        # RomM Stats
        - type: custom-api
          title: RomM Library
          url: ${ROMM_URL}/api/stats
          cache: 1d
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <style>
                .romm-stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-separator); }
                .romm-label { font-weight: 500; }
                .romm-value { color: var(--color-highlight); font-weight: bold; }
              </style>
              <div class="romm-stat">
                <span class="romm-label">Platforms</span>
                <span class="romm-value">{{ .Int "platforms" }}</span>
              </div>
              <div class="romm-stat">
                <span class="romm-label">Games</span>
                <span class="romm-value">{{ .Int "games" }}</span>
              </div>
              <div class="romm-stat">
                <span class="romm-label">Size</span>
                <span class="romm-value">{{ .String "total_size" }}</span>
              </div>
            {{ else }}
              <p class="color-negative">Failed to load RomM stats</p>
            {{ end }}

        # Immich Stats
        - type: custom-api
          title: Immich Photos
          url: ${IMMICH_URL}/api/statistics
          cache: 1h
          headers:
            x-api-key: ${IMMICH_API_KEY}
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <style>
                .immich-stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-separator); }
                .immich-label { font-weight: 500; }
                .immich-value { color: var(--color-highlight); font-weight: bold; }
              </style>
              <div class="immich-stat">
                <span class="immich-label">Photos</span>
                <span class="immich-value">{{ .Int "photos" }}</span>
              </div>
              <div class="immich-stat">
                <span class="immich-label">Videos</span>
                <span class="immich-value">{{ .Int "videos" }}</span>
              </div>
              <div class="immich-stat">
                <span class="immich-label">Storage</span>
                <span class="immich-value">{{ div (.Int "usage") 1073741824 }}GB</span>
              </div>
            {{ else }}
              <p class="color-negative">Failed to load Immich stats</p>
            {{ end }}

    # Development & GitHub
    - size: small
      widgets:
        # GitHub Personal Repos
        - type: custom-api
          title: My Repos
          url: https://api.github.com/user/repos?sort=updated&per_page=15&affiliation=owner
          cache: 30m
          headers:
            Authorization: Bearer ${GITHUB_TOKEN}
            Accept: application/vnd.github+json
          template: |
            {{ if eq .Response.StatusCode 200 }}
              <ul class="list list-gap-8">
              {{ range .JSON.Array "" }}
                <li style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--color-separator);">
                  <a href="{{ .String "html_url" }}" target="_blank" class="color-highlight" style="text-decoration: none; flex: 1;">{{ .String "name" }}</a>
                  {{ if gt (.Int "stargazers_count") 0 }}
                    <span style="font-size: 0.85rem; color: var(--color-subdue);">⭐ {{ .Int "stargazers_count" }}</span>
                  {{ end }}
                </li>
              {{ end }}
              </ul>
            {{ else }}
              <p class="color-negative">Failed to load repos</p>
            {{ end }}

        # SABnzbd Stats (Usenet Download Manager)
        - type: custom-api
          title: SABnzbd Status
          cache: 30s
          url: ${SABNZBD_URL}/api?output=json&apikey=${SABNZBD_API_KEY}&mode=queue
          headers:
            Accept: application/json
          template: |
            <div class="p-2">
              <div class="flex justify-between mb-2">
                <div class="flex-1">
                  <div class="size-h6">SPEED</div>
                  <div class="color-highlight size-h3">{{ if eq (.JSON.String "queue.status") "Downloading" }}{{ .JSON.String "queue.speed" }}B/s{{ else }}Paused{{ end }}</div>
                </div>
                <div class="flex-1">
                  <div class="size-h6">TIME LEFT</div>
                  <div class="color-highlight size-h3">{{ if eq (.JSON.String "queue.status") "Downloading" }}{{ .JSON.String "queue.timeleft" }}{{ else }}--:--:--{{ end }}</div>
                </div>
              </div>
              <div class="flex justify-between mb-2">
                <div class="flex-1">
                  <div class="size-h6">QUEUE</div>
                  <div class="color-highlight size-h3">{{ .JSON.Int "queue.noofslots" }} items</div>
                </div>
                <div class="flex-1">
                  <div class="size-h6">SIZE</div>
                  <div class="color-highlight size-h3">{{ .JSON.Float "queue.mb" | printf "%.1f" }}MB</div>
                </div>
              </div>
            </div>
